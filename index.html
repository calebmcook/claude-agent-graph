<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Graph - Collaborative Problem Solving</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }

        .input-section {
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        #problemInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
        }

        #problemInput:focus {
            outline: none;
            border-color: #5568d3;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 24px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover { background-color: #5568d3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .main-content {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 20px;
            padding: 20px;
            min-height: 700px;
        }

        .section { display: flex; flex-direction: column; }

        #visualization {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background-color: #fafbfc;
            min-height: 600px;
        }

        svg { width: 100%; height: 600px; }

        .node {
            stroke: #333;
            stroke-width: 2px;
            transition: all 0.3s;
        }

        .node.supervisor { fill: #ff6b6b; }
        .node.agent { fill: #667eea; }
        .node.thinking { animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .node.active { stroke-width: 4px; stroke: #ff6b6b; }

        .link {
            stroke: #ddd;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .link.active {
            stroke: #ff6b6b;
            stroke-width: 4px;
            animation: flash 0.5s;
        }

        @keyframes flash { 0%, 100% { stroke-opacity: 1; } 50% { stroke-opacity: 0.3; } }

        .node-label {
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
            text-anchor: middle;
            fill: white;
            text-shadow: 0 0 3px #000, 0 0 3px #000;
            paint-order: stroke;
            stroke: #000;
            stroke-width: 0.5px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-window {
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 140px;
            flex: 1;
        }

        .chat-header {
            background-color: #667eea;
            color: white;
            padding: 10px;
            font-weight: 600;
            font-size: 12px;
        }

        .chat-header.supervisor { background-color: #ff6b6b; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 11px;
        }

        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            line-height: 1.4;
        }

        .message.sent { background-color: #e7f3ff; border-left: 3px solid #667eea; }
        .message.received { background-color: #f0f0f0; border-left: 3px solid #999; }
        .message-label { font-weight: 600; color: #333; margin-bottom: 3px; font-size: 10px; }
        .message-content { color: #555; word-wrap: break-word; }

        .status-panel {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .status-panel h3 { color: #667eea; margin-bottom: 10px; font-size: 14px; }
        .status-item { margin-bottom: 8px; font-size: 12px; color: #555; }
        .status-item strong { color: #333; }

        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .metric-item {
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            text-align: center;
        }

        .metric-label { font-size: 11px; color: #666; font-weight: 600; margin-bottom: 5px; }
        .metric-value { font-size: 20px; color: #667eea; font-weight: 700; }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .status-message.loading {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-message.success {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .status-message.error {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .agent-list {
            margin-top: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .agent-item {
            font-size: 11px;
            padding: 5px;
            margin-bottom: 5px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .agent-item strong { color: #667eea; }

        .supervisor-chat-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: #fff5f5;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            margin-top: 15px;
        }

        .supervisor-chat-section h3 {
            color: #ff6b6b;
            margin: 0;
            font-size: 14px;
        }

        .supervisor-chat-messages {
            background-color: white;
            border: 1px solid #ff6b6b;
            border-radius: 6px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }

        .supervisor-chat-messages .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
        }

        .supervisor-chat-messages .message.user {
            background-color: #e7f3ff;
            border-left: 3px solid #667eea;
            text-align: right;
        }

        .supervisor-chat-messages .message.supervisor {
            background-color: #ffe7e7;
            border-left: 3px solid #ff6b6b;
        }

        .supervisor-input-group {
            display: flex;
            gap: 8px;
        }

        .supervisor-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ff6b6b;
            border-radius: 6px;
            font-size: 12px;
        }

        .supervisor-input-group input:focus {
            outline: none;
            border-color: #ff5252;
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.1);
        }

        .supervisor-input-group button {
            padding: 10px 16px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .supervisor-input-group button:hover {
            background-color: #ff5252;
        }

        .supervisor-input-group button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="header">
            <h1>ðŸ¤– Agent Graph Collaboration</h1>
            <p>Leverage a team of AI agents to solve complex problems collaboratively</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input
                    type="text"
                    id="problemInput"
                    placeholder="Enter a problem for the agents to solve (e.g., 'How can we improve customer retention?')"
                    onkeypress="if(event.key==='Enter') startSolving()"
                />
                <button id="submitBtn" onclick="startSolving()">Start</button>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h3 style="margin-bottom: 10px; color: #333;">Graph Visualization</h3>
                <div id="visualization"></div>
            </div>

            <div class="section">
                <h3 style="margin-bottom: 10px; color: #333;">Status & Messages</h3>

                <div class="status-panel">
                    <h3>Process Status</h3>
                    <div id="statusMessages"></div>
                    <div class="agent-list" id="agentList" style="display: none;">
                        <strong>Created Agents:</strong>
                        <div id="agentListContent"></div>
                    </div>
                </div>

                <h3 style="margin: 15px 0 10px 0; color: #333;">Chat History</h3>
                <div class="chat-container" id="chatContainer"></div>

                <div class="supervisor-chat-section">
                    <h3>ðŸ’¬ Chat with Supervisor</h3>
                    <p style="margin: 0 0 10px 0; color: #666; font-size: 11px;">Ask the supervisor questions or refine the problem-solving approach</p>
                    <div class="supervisor-chat-messages" id="supervisorChatMessages"></div>
                    <div class="supervisor-input-group">
                        <input
                            type="text"
                            id="supervisorInput"
                            placeholder="Ask supervisor a question..."
                            onkeypress="if(event.key==='Enter') sendSupervisorMessage()"
                        />
                        <button id="supervisorSendBtn" onclick="sendSupervisorMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics">
            <div class="metric-item">
                <div class="metric-label">Total Agents</div>
                <div class="metric-value" id="metricAgents">0</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Connections</div>
                <div class="metric-value" id="metricConnections">0</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Messages</div>
                <div class="metric-value" id="metricMessages">0</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Status</div>
                <div class="metric-value" id="metricStatus">Ready</div>
            </div>
        </div>
    </div>

    <script>
        let currentGraph = null;
        let messageCount = 0;

        async function startSolving() {
            const problem = document.getElementById('problemInput').value.trim();
            if (!problem) {
                addStatusMessage('Please enter a problem statement', 'error');
                return;
            }

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('problemInput').disabled = true;
            clearChat();
            addStatusMessage('Initializing agents...', 'loading');

            try {
                // Initialize graph
                const initRes = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ problem })
                });

                if (!initRes.ok) throw new Error('Failed to initialize');
                const initData = await initRes.json();
                currentGraph = initData.graph;
                updateVisualization();

                // Enable supervisor chat input
                document.getElementById('supervisorInput').disabled = false;
                document.getElementById('supervisorSendBtn').disabled = false;

                addStatusMessage('âœ“ Supervisor created', 'success');
                addStatusMessage('Supervisor analyzing problem...', 'loading');

                // Get supervisor's analysis
                const thinkRes = await fetch('/api/supervisor-think', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ problem })
                });

                // Log response status
                console.log('Supervisor think response status:', thinkRes.status);

                if (!thinkRes.ok) {
                    let errorMsg = 'Failed to get supervisor analysis';
                    try {
                        const errorData = await thinkRes.json();
                        console.error('Server error details:', errorData);
                        errorMsg = errorData.error || errorMsg;
                        if (errorData.error_type) {
                            errorMsg += ` (${errorData.error_type})`;
                        }
                    } catch (e) {
                        const errorText = await thinkRes.text();
                        console.error('Raw error response:', errorText);
                    }
                    throw new Error(errorMsg);
                }
                const thinkData = await thinkRes.json();
                console.log('Supervisor thinking result:', thinkData);

                addStatusMessage('âœ“ Analysis complete', 'success');

                if (thinkData.agents && thinkData.agents.length > 0) {
                    addStatusMessage(`âœ“ Created ${thinkData.agents.length} specialist agents`, 'success');
                    showAgentList(thinkData.agents);
                    currentGraph = thinkData.graph;
                    updateVisualization();
                }

                addStatusMessage('Supervisor delegating tasks...', 'loading');

                // Get delegations
                const delRes = await fetch('/api/delegate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ problem })
                });
                if (!delRes.ok) throw new Error('Failed to get delegations');
                const delData = await delRes.json();

                console.log('Delegation data:', delData);
                console.log('Delegations count:', delData.delegations?.length || 0);

                addStatusMessage('âœ“ Tasks delegated', 'success');
                currentGraph = delData.graph;
                updateVisualization();

                // Get agent responses
                if (!delData.delegations || delData.delegations.length === 0) {
                    addStatusMessage('Warning: No delegations returned from supervisor', 'error');
                    console.warn('No delegations to process');
                }

                for (const delegation of (delData.delegations || [])) {
                    addStatusMessage(`Getting response from ${delegation.agent}...`, 'loading');

                    const respRes = await fetch('/api/agent-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            agent: delegation.agent,
                            task: delegation.task
                        })
                    });

                    if (respRes.ok) {
                        const respData = await respRes.json();
                        addChatMessage(delegation.agent, 'supervisor', respData.response);
                        messageCount++;
                    }
                }

                addStatusMessage('âœ“ Problem solving complete!', 'success');
                document.getElementById('metricStatus').textContent = 'Complete';

            } catch (error) {
                console.error('Full error in startSolving:', error);
                console.error('Error stack:', error.stack);
                addStatusMessage(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('problemInput').disabled = false;
            }
        }

        function addStatusMessage(message, type = 'loading') {
            const container = document.getElementById('statusMessages');
            const msg = document.createElement('div');
            msg.className = `status-message ${type}`;
            msg.textContent = message;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function showAgentList(agents) {
            const list = document.getElementById('agentList');
            const content = document.getElementById('agentListContent');
            content.innerHTML = agents.map(a =>
                `<div class="agent-item"><strong>${a.id}</strong>: ${a.role}</div>`
            ).join('');
            list.style.display = 'block';
        }

        function addChatMessage(from, to, content) {
            const container = document.getElementById('chatContainer');

            // Find or create chat window for sender
            let chatWindow = document.getElementById(`chat_${from}`);
            if (!chatWindow) {
                chatWindow = createChatWindow(from);
                container.appendChild(chatWindow);
            }

            const messages = chatWindow.querySelector('.chat-messages');
            const msg = document.createElement('div');
            msg.className = 'message sent';
            msg.innerHTML = `<div class="message-label">To ${to}:</div><div class="message-content">${escapeHtml(content.substring(0, 200))}...</div>`;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;

            updateMetrics();
        }

        function createChatWindow(agentId) {
            const div = document.createElement('div');
            div.id = `chat_${agentId}`;
            div.className = 'chat-window';
            div.innerHTML = `
                <div class="chat-header ${agentId === 'supervisor' ? 'supervisor' : ''}">
                    ${agentId === 'supervisor' ? 'Supervisor' : agentId.replace('_', ' ').toUpperCase()}
                </div>
                <div class="chat-messages"></div>
            `;
            return div;
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('statusMessages').innerHTML = '';
            document.getElementById('agentList').style.display = 'none';
            messageCount = 0;
        }

        function updateVisualization() {
            if (!currentGraph) return;

            d3.select('#visualization').selectAll('*').remove();
            const width = document.getElementById('visualization').clientWidth;
            const height = 600;

            const svg = d3.select('#visualization')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const simulation = d3.forceSimulation(currentGraph.nodes)
                .force('link', d3.forceLink(currentGraph.links)
                    .id(d => d.id)
                    .distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));

            const link = svg.selectAll('line')
                .data(currentGraph.links)
                .enter()
                .append('line')
                .attr('class', 'link');

            const node = svg.selectAll('circle')
                .data(currentGraph.nodes)
                .enter()
                .append('circle')
                .attr('class', d => `node ${d.metadata.role || 'agent'}`)
                .attr('r', d => d.metadata.role === 'supervisor' ? 20 : 15)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            const label = svg.selectAll('text')
                .data(currentGraph.nodes)
                .enter()
                .append('text')
                .attr('class', 'node-label')
                .text(d => d.id.replace('_', '\n'));

            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label.attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            updateMetrics();
        }

        function updateMetrics() {
            if (currentGraph) {
                document.getElementById('metricAgents').textContent = currentGraph.nodes.length;
                document.getElementById('metricConnections').textContent = currentGraph.links.length;
                document.getElementById('metricMessages').textContent = messageCount;
            }
        }

        async function sendSupervisorMessage() {
            const input = document.getElementById('supervisorInput');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            const sendBtn = document.getElementById('supervisorSendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            try {
                // Add user message to chat
                addSupervisorChatMessage('user', message);
                input.value = '';

                // Send to supervisor
                const response = await fetch('/api/supervisor-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error(`Failed to get supervisor response: ${response.status}`);
                }

                const data = await response.json();
                console.log('Supervisor response:', data);

                // Add supervisor response to chat
                addSupervisorChatMessage('supervisor', data.response);

            } catch (error) {
                console.error('Error sending supervisor message:', error);
                addSupervisorChatMessage('supervisor', `Error: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        function addSupervisorChatMessage(sender, message) {
            const container = document.getElementById('supervisorChatMessages');
            const msg = document.createElement('div');
            msg.className = `message ${sender}`;
            msg.textContent = message;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateVisualization();
            // Disable supervisor input until a graph is initialized
            document.getElementById('supervisorInput').disabled = true;
            document.getElementById('supervisorSendBtn').disabled = true;
        });
    </script>
</body>
</html>
